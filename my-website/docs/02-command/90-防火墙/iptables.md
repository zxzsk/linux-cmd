ç»å…¸é˜²ç«å¢™ï¼ˆæ­£åœ¨è¢«æ›¿ä»£ï¼‰



**iptables** æ˜¯ Linux æ“ä½œç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„é˜²ç«å¢™å·¥å…·ã€‚

## 1. ä»€ä¹ˆæ˜¯ iptablesï¼Ÿ ğŸ¤”

**iptables** æ˜¯ Linux æ“ä½œç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„é˜²ç«å¢™å·¥å…·ï¼Œå®ƒç”¨äºè¿‡æ»¤å’Œç®¡ç†ç½‘ç»œæµé‡ã€‚iptables åŸºäºè§„åˆ™é›†æ¥æ§åˆ¶è¿›å‡º Linux ç³»ç»Ÿçš„ç½‘ç»œæµé‡ã€‚å®ƒèƒ½å¤Ÿæ ¹æ® IP åœ°å€ã€ç«¯å£ã€åè®®ç­‰æ¡ä»¶è¿‡æ»¤æ•°æ®åŒ…ï¼Œå¹¶ä¸ºç³»ç»Ÿæä¾›å¼ºå¤§çš„å®‰å…¨æ€§ä¿æŠ¤ã€‚ğŸš€

| ç‰¹ç‚¹           | æè¿°                                                |
| ---------------- | ----------------------------------------------------- |
| é«˜åº¦å¯å®šåˆ¶     | å…è®¸æ ¹æ®ä¸åŒçš„ç½‘ç»œéœ€æ±‚å’Œå®‰å…¨ç­–ç•¥æ¥å®šåˆ¶è§„åˆ™ã€‚        |
| æ€§èƒ½é«˜æ•ˆ       | ç›´æ¥æ“ä½œå†…æ ¸çš„ç½‘ç»œæ ˆï¼Œå…·æœ‰æä½çš„æ€§èƒ½å¼€é”€ã€‚          |
| å¼ºå¤§çš„è§„åˆ™æ”¯æŒ | æ”¯æŒå¤šç§åè®®ï¼ˆTCPã€UDPã€ICMP ç­‰ï¼‰å’Œå„ç§ç½‘ç»œå±‚è¿‡æ»¤ã€‚ |

## 2. å®‰è£… iptables ğŸ“¥

### 2.1 å®‰è£… iptables

åœ¨å¤§å¤šæ•° Linux å‘è¡Œç‰ˆä¸­ï¼Œiptables é€šå¸¸æ˜¯é¢„è£…çš„ã€‚å¦‚æœæ²¡æœ‰å®‰è£…ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…å®ƒï¼š

åœ¨ Ubuntu æˆ– Debian ç³»ç»Ÿä¸Šï¼š

```bash
sudo apt update
sudo apt install iptables
```

åœ¨ CentOS æˆ– RHEL ç³»ç»Ÿä¸Šï¼š

```bash
sudo yum install iptables
```

### 2.2 æ£€æŸ¥ iptables çŠ¶æ€

å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ iptables æœåŠ¡çš„çŠ¶æ€ï¼š

```bash
sudo systemctl status iptables
```

å¦‚æœæ²¡æœ‰å®‰è£…æˆ–æœªå¯ç”¨ï¼Œä½ å¯ä»¥å¯åŠ¨ iptables æœåŠ¡ï¼š

```bash
sudo systemctl start iptables
```

## 3. é…ç½® iptables é˜²ç«å¢™ âš™ï¸

### 3.1 åŸºæœ¬å‘½ä»¤æ ¼å¼

iptables çš„å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š

```bash
sudo iptables -A <CHAIN> -p <PROTOCOL> --dport <PORT> -j <ACTION>
```

*  **-A**: æ·»åŠ è§„åˆ™ï¼ˆAppendï¼‰ã€‚
*  **-p**: æŒ‡å®šåè®®ï¼Œå¦‚ `tcp`ã€`udp` æˆ– `icmp`ã€‚
*  **--dport**: ç›®æ ‡ç«¯å£ã€‚
*  **-j**: æŒ‡å®šåŠ¨ä½œï¼ˆå¦‚ ACCEPTã€DROPã€REJECT ç­‰ï¼‰ã€‚

### 3.2 é…ç½®å¸¸è§çš„é˜²ç«å¢™è§„åˆ™

#### 3.2.1 å…è®¸ SSH è®¿é—®

é»˜è®¤æƒ…å†µä¸‹ï¼ŒLinux é˜²ç«å¢™ä¼šé˜»æ­¢æ‰€æœ‰ä¼ å…¥çš„è¿æ¥ã€‚è¦å…è®¸ SSHï¼ˆç«¯å£ 22ï¼‰çš„è¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

#### 3.2.2 å…è®¸ HTTP å’Œ HTTPS è®¿é—®

è¦å…è®¸ HTTPï¼ˆç«¯å£ 80ï¼‰å’Œ HTTPSï¼ˆç«¯å£ 443ï¼‰çš„è®¿é—®ï¼š

```bash
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

#### 3.2.3 æ‹’ç» ICMPï¼ˆPingï¼‰è¯·æ±‚

ä¸ºäº†å¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå¯èƒ½éœ€è¦ç¦ç”¨ Ping è¯·æ±‚ï¼ˆICMPï¼‰ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‹’ç»æ‰€æœ‰ä¼ å…¥çš„ ICMP è¯·æ±‚ï¼š

```bash
sudo iptables -A INPUT -p icmp --icmp-type echo-request -j REJECT
```

#### 3.2.4 å…è®¸æ¥è‡ªç‰¹å®š IP åœ°å€çš„æµé‡

å¦‚æœä½ å¸Œæœ›åªå…è®¸æ¥è‡ªç‰¹å®š IP åœ°å€çš„è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```bash
sudo iptables -A INPUT -p tcp -s 192.168.1.100 --dport 22 -j ACCEPT
```

#### 3.2.5 é»˜è®¤æ‹’ç»æ‰€æœ‰æµé‡

ä¸ºäº†æé«˜å®‰å…¨æ€§ï¼Œå»ºè®®è®¾ç½®é»˜è®¤è§„åˆ™ä¸ºæ‹’ç»æ‰€æœ‰ä¼ å…¥è¿æ¥ï¼š

```bash
sudo iptables -P INPUT DROP
```

è¿™å°†é˜»æ­¢æ‰€æœ‰æœªæ˜ç¡®å…è®¸çš„æµé‡ã€‚

### 3.3 é…ç½®è§„åˆ™é“¾

iptables ä½¿ç”¨è§„åˆ™é“¾ï¼ˆChainï¼‰æ¥ç»„ç»‡ä¸åŒçš„è§„åˆ™ã€‚å¸¸è§çš„è§„åˆ™é“¾æœ‰ï¼š

* **INPUT**ï¼šå¤„ç†è¿›å…¥ç³»ç»Ÿçš„æµé‡ã€‚
* **OUTPUT**ï¼šå¤„ç†ä»ç³»ç»Ÿå‘å‡ºçš„æµé‡ã€‚
* **FORWARD**ï¼šå¤„ç†è½¬å‘æµé‡ã€‚

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰è§„åˆ™ï¼š

```bash
sudo iptables -L
```

å¦‚æœæƒ³è¦åˆ é™¤æŸæ¡è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
sudo iptables -D INPUT -p tcp --dport 22 -j ACCEPT
```

## 4. ä¿å­˜å’Œæ¢å¤ iptables è§„åˆ™ ğŸ”§

### 4.1 ä¿å­˜è§„åˆ™

åœ¨ç³»ç»Ÿé‡å¯åï¼Œiptables é…ç½®ä¼šä¸¢å¤±ã€‚å› æ­¤ï¼Œå¿…é¡»ä¿å­˜è§„åˆ™ï¼š

åœ¨ Ubuntu æˆ– Debian ç³»ç»Ÿä¸Šï¼š

```bash
sudo iptables-save > /etc/iptables/rules.v4
```

åœ¨ CentOS æˆ– RHEL ç³»ç»Ÿä¸Šï¼š

```bash
sudo service iptables save
```

### 4.2 æ¢å¤è§„åˆ™

å¦‚æœä½ éœ€è¦æ¢å¤ä¿å­˜çš„è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

åœ¨ Ubuntu æˆ– Debian ç³»ç»Ÿä¸Šï¼š

```bash
sudo iptables-restore < /etc/iptables/rules.v4
```

åœ¨ CentOS æˆ– RHEL ç³»ç»Ÿä¸Šï¼š

```bash
sudo service iptables restart
```

## 5. é…ç½®é˜²ç«å¢™å¼€æœºè‡ªå¯ âš¡

### 5.1 å¯åŠ¨ iptables å¼€æœºè‡ªå¯

ä¸ºäº†ç¡®ä¿ç³»ç»Ÿé‡å¯å iptables è‡ªåŠ¨å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
sudo systemctl enable iptables
```

### 5.2 ç¡®ä¿ iptables æœåŠ¡æ­£åœ¨è¿è¡Œ

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¡®ä¿ iptables æœåŠ¡æ­£åœ¨è¿è¡Œï¼š

```bash
sudo systemctl start iptables
```

## 6. æŸ¥çœ‹å’Œè°ƒè¯• iptables è§„åˆ™ ğŸ› ï¸

### 6.1 æŸ¥çœ‹ç°æœ‰è§„åˆ™

è¦æŸ¥çœ‹å½“å‰çš„æ‰€æœ‰ iptables è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
sudo iptables -L -v
```

è¯¥å‘½ä»¤ä¼šåˆ—å‡ºæ‰€æœ‰è§„åˆ™ï¼Œå¹¶æ˜¾ç¤ºè¯¦ç»†çš„æµé‡è®¡æ•°ä¿¡æ¯ã€‚

### 6.2 æŸ¥çœ‹ NAT è¡¨è§„åˆ™

å¦‚æœä½ é…ç½®äº† NATï¼ˆä¾‹å¦‚ç«¯å£è½¬å‘ï¼‰ï¼Œå¯ä»¥æŸ¥çœ‹ NAT è¡¨è§„åˆ™ï¼š

```bash
sudo iptables -t nat -L -v
```

### 6.3 å¯ç”¨æ—¥å¿—è®°å½•

ä½ å¯ä»¥ä½¿ç”¨ iptables è¿›è¡Œæ—¥å¿—è®°å½•ï¼Œä¾‹å¦‚è®°å½•è¢«æ‹’ç»çš„è¿æ¥ï¼š

```bash
sudo iptables -A INPUT -j LOG --log-prefix "iptables denied: "
```

æ—¥å¿—ä¼šå†™å…¥ `/var/log/syslog`ï¼Œä½ å¯ä»¥æŸ¥çœ‹è¢«æ‹’ç»çš„è¿æ¥ã€‚

## 7. é«˜çº§ iptables é…ç½® ğŸŒ

### 7.1 é…ç½®ç«¯å£è½¬å‘

å¦‚æœä½ éœ€è¦å°†å¤–éƒ¨çš„æŸä¸ªç«¯å£æµé‡è½¬å‘åˆ°å†…éƒ¨çš„å¦ä¸€ä¸ªç«¯å£ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

ä¾‹å¦‚ï¼Œå°†æ‰€æœ‰æ¥è‡ªå¤–éƒ¨ç«¯å£ 8080 çš„æµé‡è½¬å‘åˆ°å†…éƒ¨ç«¯å£ 80ï¼š

```bash
sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80
```

### 7.2 é…ç½®çŠ¶æ€è·Ÿè¸ª

iptables æ”¯æŒåŸºäºè¿æ¥çŠ¶æ€çš„è¿‡æ»¤ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä»…å…è®¸å·²ç»å»ºç«‹çš„è¿æ¥ï¼š

```bash
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

### 7.3 é™åˆ¶è¿æ¥é€Ÿç‡

ä¸ºäº†é˜²æ­¢æš´åŠ›ç ´è§£ï¼Œå¯ä»¥é™åˆ¶æŸäº›æœåŠ¡çš„è¿æ¥é€Ÿç‡ï¼Œä¾‹å¦‚é™åˆ¶ SSH æ¯ç§’çš„è¿æ¥æ¬¡æ•°ï¼š

```bash
sudo iptables -A INPUT -p tcp --dport 22 -m limit --limit 5/min -j ACCEPT
```

## 8. å°ç»“ ğŸ‰

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å·²ç»äº†è§£äº†å¦‚ä½•å®‰è£…ã€é…ç½®å’Œç®¡ç† iptables é˜²ç«å¢™ï¼Œå¢å¼ºäº† Linux ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚iptables æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ ç²¾ç»†åœ°æ§åˆ¶æµé‡ã€æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚å¸Œæœ›è¿™ç¯‡æ•™ç¨‹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼ğŸš€ åˆ«å¿˜äº†æ”¶è— **åœ¨çº¿çŸ¥è¯†åº“**ï¼ˆ [www.zxzsk.com](http://www.zxzsk.com/) ï¼‰å“¦ï¼ğŸ˜Š